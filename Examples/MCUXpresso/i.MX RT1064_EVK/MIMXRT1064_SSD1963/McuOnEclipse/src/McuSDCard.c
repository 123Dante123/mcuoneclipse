/* ###################################################################
**     This component module is generated by Processor Expert. Do not modify it.
**     Filename    : McuSDCard.h
**     Project     : FRDM-K64F_Generator
**     Processor   : MK64FN1M0VLL12
**     Component   : SD_Card
**     Version     : Component 01.184, Driver 01.00, CPU db: 3.00.000
**     Compiler    : GNU C Compiler
**     Date/Time   : 2018-07-03, 08:21, # CodeGen: 331
**     Abstract    :
**         Implements interface to SD card for FatFs
**     Settings    :
**          Component name                                 : McuSDCard
**          Block size                                     : 512
**          Cmd wait counter                               : 10
**          Wait Ready Timeout (ms)                        : 500
**          Wait Cmd Timeout (ms)                          : 100
**          Receive Block Timeout (ms)                     : 500
**          SPI Block Transfer                             : no
**          Hardware                                       : 
**            SW SPI                                       : Enabled
**              SPI                                        : McuGenericSWSPI
**            HW SPI                                       : Disabled
**            SPI Read/Write Macros                        : Disabled
**            Activate SPI bus                             : no
**            Slave Select                                 : Enabled
**              LDD SS                                     : Enabled
**                Slave Select Pin                         : LDDSS
**              non-LDD SS                                 : Disabled
**            Activate                                     : Disabled
**            Card detection                               : Disabled
**            Report 'Card present' if no Card detection pin : yes
**            Write protection                             : Disabled
**          System                                         : 
**            Wait                                         : McuWait
**            Timeout                                      : McuTimeout
**            RTOS                                         : Enabled
**              RTOS                                       : McuRTOS
**     Contents    :
**         Activate         - void McuSDCard_Activate(void);
**         Deactivate       - void McuSDCard_Deactivate(void);
**         isWriteProtected - bool McuSDCard_isWriteProtected(void);
**         CardPresent      - bool McuSDCard_CardPresent(void);
**         WaitReady        - uint8_t McuSDCard_WaitReady(void);
**         ReceiveDataBlock - bool McuSDCard_ReceiveDataBlock(uint8_t *data, uint16_t nofBytes);
**         SendDataBlock    - bool McuSDCard_SendDataBlock(uint8_t *data, uint8_t token, uint16_t nofBytes);
**         SendCmd          - uint8_t McuSDCard_SendCmd(uint8_t cmd, uint32_t arg);
**         SetSlowMode      - void McuSDCard_SetSlowMode(void);
**         SetFastMode      - void McuSDCard_SetFastMode(void);
**         InitCommChannel  - void McuSDCard_InitCommChannel(void);
**         Deinit           - uint8_t McuSDCard_Deinit(void* unused);
**         Init             - uint8_t McuSDCard_Init(void* unused);
**
** * Copyright (c) 2012-2017, Erich Styger
**  * Web:         https://mcuoneclipse.com
**  * SourceForge: https://sourceforge.net/projects/mcuoneclipse
**  * Git:         https://github.com/ErichStyger/McuOnEclipse_PEx
**  * All rights reserved.
**  *
**  * Redistribution and use in source and binary forms, with or without modification,
**  * are permitted provided that the following conditions are met:
**  *
**  * - Redistributions of source code must retain the above copyright notice, this list
**  *   of conditions and the following disclaimer.
**  *
**  * - Redistributions in binary form must reproduce the above copyright notice, this
**  *   list of conditions and the following disclaimer in the documentation and/or
**  *   other materials provided with the distribution.
**  *
**  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
**  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
**  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
**  * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
**  * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
**  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
**  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
**  * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
**  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
**  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
** ###################################################################*/
/*!
** @file McuSDCard.h
** @version 01.00
** @brief
**         Implements interface to SD card for FatFs
*/         
/*!
**  @addtogroup McuSDCard_module McuSDCard module documentation
**  @{
*/         

/* MODULE McuSDCard. */

#include "McuSDCard.h"
#include "diskio.h"

static volatile DSTATUS Stat = STA_NOINIT; /* Disk status */
static uint8_t CardType = CT_SD1;       /* Card type flags */
static uint8_t currentSpeedMode = McuSDCard_ACTIVATE_MODE_NONE; /* current speed mode */

enum { /* SD card response codes */
  McuSDCard_OK = 0,
  McuSDCard_IDLE = 1
};

#define McuSDCard_SPI_WRITE_BLOCK_ENABLED          0
#define McuSDCard_SPI_WRITE_READ_BLOCK_ENABLED     0

/* different wait counters to deal with slow SD cards */
#define McuSDCard_TIMEOUT_READY_MS       500 /* user configured wait timeout until the device is ready */
#define McuSDCard_TIMEOUT_CMD_MS         100 /* user configured wait timeout for commands */
#define McuSDCard_TIMEOUT_READ_BLOCK_MS  500 /* user configured wait timeout for reading a data block */
#define McuSDCard_ENABLE_SS()   SS1_ClrVal(SS1_DeviceData) /* enable slave (low active) */
#define McuSDCard_DISABLE_SS()  SS1_SetVal(SS1_DeviceData) /* disable slave (low active) */
#define McuSDCard_DUMMY 0xff /* SPI dummy value */

/*-----------------------------------------------------------------------*/
/* Initialize a Drive                                                    */
DSTATUS McuSDCard_disk_initialize (
        uint8_t drv                     /* Physical drive number (0..) */
)
{
  uint8_t n, cmd, ty, ocr[4];

  (void)drv; /* not used */
  if (Stat&STA_NODISK) {
    return Stat;                        /* No card in the socket */
  }
  if (McuSDCard_Init(NULL) != ERR_OK) {
    return STA_NOINIT;
  }
  ty = 0;
  if (McuSDCard_SendCmd(McuSDCard_CMD0, 0) == 1) { /* Enter Idle state */
    if (McuSDCard_SendCmd(McuSDCard_CMD8, 0x1AA) == 1) { /* SDHC */
      for (n = 0; n < 4; n++) {
        ocr[n] = McuSDCard_ReceiveByte(); /* Get trailing return value of R7 resp */
      }
      if (ocr[2] == 0x01 && ocr[3] == 0xAA) { /* The card can work at vdd range of 2.7-3.6V */
        while (McuSDCard_SendCmd(McuSDCard_ACMD41, 1UL << 30)) {
          /* Wait for leaving idle state (ACMD41 with HCS bit) */
        }
        if (McuSDCard_SendCmd(McuSDCard_CMD58, 0) == 0) { /* Check CCS bit in the OCR */
          for (n = 0; n < 4; n++) {
            ocr[n] = McuSDCard_ReceiveByte();
          }
          ty = (uint8_t)((ocr[0] & 0x40) ? CT_SD2 | CT_BLOCK : CT_SD2); /* SDv2 */
        }
      }
    } else {                            /* SDSC or MMC */
      if (McuSDCard_SendCmd(McuSDCard_ACMD41, 0) <= 1) {
        ty = CT_SD1; cmd = McuSDCard_ACMD41; /* SDv1 */
      } else {
        ty = CT_MMC; cmd = McuSDCard_CMD1; /* MMCv3 */
      }
      while (McuSDCard_SendCmd(cmd, 0)) {
        /* Wait for leaving idle state */
      }
      if (McuSDCard_SendCmd(McuSDCard_CMD16, McuSDCard_BLOCK_SIZE) != 0) { /* Set R/W block length  */
        ty = 0;
      }
    }
    McuSDCard_SetFastMode();
  }
  CardType = ty;
  Stat &= ~STA_NOINIT;                  /* Clear STA_NOINIT */
  return Stat;
}

/*-----------------------------------------------------------------------*/
/* Return Disk Status                                                    */
DSTATUS McuSDCard_disk_status (
        uint8_t drv                     /* Physical drive number (0..) */
)
{
  (void)drv; /* not used */
  return Stat;
}

/*-----------------------------------------------------------------------*/
/* Read Sector(s)                                                        */
DRESULT McuSDCard_disk_read (
        uint8_t drv,                    /* Physical drive number (0..) */
        uint8_t *buff,                  /* Data buffer to store read data */
        uint32_t sector,                /* Sector address (LBA) */
        unsigned int count              /* Number of sectors to read (1..255) */
)
{
  (void)drv; /* not used */
  if (!count) {
    return RES_PARERR;
  }
  if (Stat & STA_NOINIT) {
    return RES_NOTRDY;
  }
  if (!(CardType & CT_BLOCK)) {
    sector *= McuSDCard_BLOCK_SIZE;     /* Convert to byte address if needed */
  }
  if (count == 1) {                     /* Single block read */
    if (   (McuSDCard_SendCmd(McuSDCard_CMD17, sector) == 0) /* READ_SINGLE_BLOCK */
        && McuSDCard_ReceiveDataBlock(buff, McuSDCard_BLOCK_SIZE))
    {
      count = 0;
    }
  } else {                              /* Multiple block read */
    if (McuSDCard_SendCmd(McuSDCard_CMD18, sector) == 0) { /* READ_MULTIPLE_BLOCK */
      do {
        if (!McuSDCard_ReceiveDataBlock(buff, McuSDCard_BLOCK_SIZE)) {
          break;
        }
        buff += McuSDCard_BLOCK_SIZE;
      } while (--count);
      (void)McuSDCard_SendCmd(McuSDCard_CMD12, 0); /* STOP_TRANSMISSION */
    }
  }
  return count ? RES_ERROR : RES_OK;
}

/*-----------------------------------------------------------------------*/
/* Write Sector(s)                                                       */
#if _READONLY == 0
DRESULT McuSDCard_disk_write (
        uint8_t drv,                    /* Physical drive number (0..) */
        const uint8_t *buff,            /* Data to be written */
        uint32_t sector,                /* Sector address (LBA) */
        unsigned int count              /* Number of sectors to write (1..255) */
)
{
  (void)drv; /* not used */
  if (!count) {
    return RES_PARERR;
  }
  if (Stat & STA_NOINIT) {
    return RES_NOTRDY;
  }
  if (Stat & STA_PROTECT) {
    return RES_WRPRT;
  }
  if (!(CardType & CT_BLOCK)) {
    sector *= McuSDCard_BLOCK_SIZE;     /* Convert to byte address if needed */
  }
  if (count == 1) {                     /* Single block write */
    if (  (McuSDCard_SendCmd(McuSDCard_CMD24, sector) == 0) /* WRITE_BLOCK */
        && McuSDCard_SendDataBlock((uint8_t*)buff, 0xFE, McuSDCard_BLOCK_SIZE))
    {
      count = 0;
    }
  } else {                              /* Multiple block write */
    if (CardType & CT_SDC) {
      (void)McuSDCard_SendCmd(McuSDCard_ACMD23, count);
    }
    if (McuSDCard_SendCmd(McuSDCard_CMD25, sector) == 0) { /* WRITE_MULTIPLE_BLOCK */
      do {
        if (!McuSDCard_SendDataBlock((uint8_t*)buff, 0xFC, McuSDCard_BLOCK_SIZE)) {
          break;
        }
        buff += McuSDCard_BLOCK_SIZE;
      } while (--count);
      if (!McuSDCard_SendDataBlock(0, 0xFD, McuSDCard_BLOCK_SIZE)) { /* STOP_TRAN token */
        count = 1;
      }
    }
  }
  return count ? RES_ERROR : RES_OK;
}
#endif /* _READONLY */
/*-----------------------------------------------------------------------*/
/* Miscellaneous Functions                                               */
static uint8_t chk_power(void) { return 1;}
static void power_off(void) {}
static void power_on(void) {}
/*-----------------------------------------------------------------------*/
DRESULT McuSDCard_disk_ioctl (
        uint8_t drv,                    /* Physical drive number (0..) */
        uint8_t ctrl,                   /* Control code */
        void *buff                      /* Buffer to send/receive control data */
)
{
  DRESULT res = RES_OK;
  uint8_t n, csd[16], *ptr = (uint8_t*)buff;
  uint16_t csize;

  (void)drv; /* not used */
  if (ctrl == CTRL_POWER) {
    switch (*ptr) {
      case 0:                           /* Sub control code == 0 (POWER_OFF) */
        if (chk_power()) {
        /*lint -save -e522 Highest operation lacks side effect */
          power_off();                  /* Power off */
        /*lint -restore */
        }
        break;
      case 1:                           /* Sub control code == 1 (POWER_ON) */
        /*lint -save -e522 Highest operation lacks side effect */
        power_on();                     /* Power on */
        /*lint -restore */
        break;
      case 2:                           /* Sub control code == 2 (POWER_GET) */
        *(ptr+1) = (uint8_t)chk_power();
        break;
      default:
        res = RES_PARERR;
    } /* switch */
  } else {
    if (Stat & STA_NOINIT) {
      return RES_NOTRDY;
    }
    switch (ctrl) {
      case CTRL_SYNC :                  /* Make sure that no pending write process. Do not remove this or written sector might not left updated. */
        if (McuSDCard_WaitReady() != ERR_OK) {
          res = RES_ERROR;
        }
        break;
      case MMC_GET_READ_BL_LEN:         /* get Block Length */
        if ((McuSDCard_SendCmd(McuSDCard_CMD9, 0) == 0) && McuSDCard_ReceiveDataBlock(csd, 16)) {
          switch((csd[5]&15)) {         /* READ_BL_LEN is either 9, 10 or 11, end the block size is 2^READ_BL_LEN */
            case 9: *(uint16_t*)ptr = 512; break;
            case 10: *(uint16_t*)ptr = 1024; break;
            case 11: *(uint16_t*)ptr = 2048; break;
            default: *(uint16_t*)ptr = 0; break; /* illegal */
          }
        }
        break;
      case MMC_GET_SDC_VERSION:         /* get CSD Version (1 byte: 1 for 1.xx or MMC, 2 for 2.0 */
        if ((McuSDCard_SendCmd(McuSDCard_CMD9, 0) == 0) && McuSDCard_ReceiveDataBlock(csd, 16)) {
          if ((csd[0] >> 6) == 1) {     /* SDC ver 2.00 */
            *ptr = 2;
          } else {                      /* SDC ver 1.XX or MMC*/
            *ptr = 1;
          }
        }
        break;
      case GET_SECTOR_COUNT :           /* Get number of sectors on the disk (uint32_t) */
        if ((McuSDCard_SendCmd(McuSDCard_CMD9, 0) == 0) && McuSDCard_ReceiveDataBlock(csd, 16)) {
          if ((csd[0] >> 6) == 1) {     /* SDC ver 2.00 */
            csize = (uint16_t)(csd[9] + ((uint16_t)csd[8] << 8) + 1);
            *(uint32_t*)buff = (uint32_t)csize << 10;
          } else {                      /* SDC ver 1.XX or MMC*/
            n = (uint8_t)((csd[5] & 15) + ((csd[10] & 128) >> 7) + ((csd[9] & 3) << 1) + 2);
            csize = (uint16_t)((csd[8] >> 6) + ((uint16_t)csd[7] << 2) + ((uint16_t)(csd[6] & 3) << 10) + 1);
            *(uint32_t*)buff = (uint32_t)csize << (uint8_t)(n - 9);
          }
        }
        break;
      case GET_SECTOR_SIZE :            /* Get R/W sector size (uint16_t) */
        *(uint16_t*)buff = McuSDCard_BLOCK_SIZE;
        break;
      case GET_BLOCK_SIZE :             /* Get erase block size in unit of sector (uint32_t) */
        if (CardType & CT_SD2) {        /* SDC ver 2.00 */
          if (McuSDCard_SendCmd(McuSDCard_ACMD13, 0) == 0) { /* Read SD status */
            (void)McuSDCard_ReceiveByte();
            if (McuSDCard_ReceiveDataBlock(csd, 16)) { /* Read partial block */
              for (n = 64 - 16; n; n--) {
                (void)McuSDCard_ReceiveByte(); /* Purge trailing data */
              }
              *(uint32_t*)buff = 16UL << (csd[10] >> 4);
            }
          }
        } else {                        /* SDC ver 1.XX or MMC */
          if ((McuSDCard_SendCmd(McuSDCard_CMD9, 0) == 0) && McuSDCard_ReceiveDataBlock(csd, 16)) {        /* Read CSD */
            if (CardType & CT_SD1) {    /* SDC ver 1.XX */
              *(uint32_t*)buff = (uint32_t)((((csd[10] & 63) << 1) + ((uint16_t)(csd[11] & 128) >> 7) + 1) << (uint8_t)((csd[13] >> 6) - 1));
            } else {                    /* MMC */
              *(uint32_t*)buff = (uint32_t)(((uint16_t)((csd[10] & 124) >> 2) + 1) * (((csd[11] & 3) << 3) + ((csd[11] & 224) >> 5) + 1));
            }
          }
        }
        break;
      case MMC_GET_TYPE :               /* Get card type flags (1 byte) */
        *ptr = CardType;
        break;

      case MMC_GET_CSD :                /* Receive CSD as a data block (16 bytes) */
         if (!(McuSDCard_SendCmd(McuSDCard_CMD9, 0) == 0 /* READ_CSD */
            && McuSDCard_ReceiveDataBlock(ptr, 16)))
         {
           res = RES_PARERR;
         }
         break;
      case MMC_GET_CID :                /* Receive CID as a data block (16 bytes) */
        if (!(McuSDCard_SendCmd(McuSDCard_CMD10, 0) == 0 /* READ_CID */
            && McuSDCard_ReceiveDataBlock(ptr, 16)))
        {
          res = RES_PARERR;
        }
        break;

      case MMC_GET_OCR :                /* Receive OCR as an R3 resp (4 bytes) */
        if (McuSDCard_SendCmd(McuSDCard_CMD58, 0) == 0) { /* READ_OCR */
          for (n = 4; n; n--) {
            *ptr++ = McuSDCard_ReceiveByte();
          }
        } else {
          res = RES_PARERR;
        }
        break;

      case MMC_GET_SDSTAT :             /* Receive SD status as a data block (64 bytes) */
        if (McuSDCard_SendCmd(McuSDCard_ACMD13, 0) == 0) { /* SD_STATUS */
          (void)McuSDCard_ReceiveByte();
          if (!McuSDCard_ReceiveDataBlock(ptr, 64)) {
            res = RES_PARERR;
          }
        } else {
          res = RES_PARERR;
        }
        break;

      case MMC_GET_DRIVER_VERSION:      /* 1 byte: return: 0 SPI driver, 1 LLD SDHC driver */
        *ptr = 0;
        break;

      default:
        res = RES_PARERR;
    } /* switch */
  } /* if-else */
  return res;
}


#if McuSDCard_SPI_WRITE_BLOCK_ENABLED || McuSDCard_SPI_WRITE_READ_BLOCK_ENABLED
#if McuSDCard_BLOCK_SIZE==512
  #define SPI_WRITE_READ_BLOCK_SIZE_DUMMY 512 /* 512 bytes of dummy values */
  static const uint8_t dummyArr[SPI_WRITE_READ_BLOCK_SIZE_DUMMY] = {
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY
  };
#elif McuSDCard_BLOCK_SIZE==1024
  #define SPI_WRITE_READ_BLOCK_SIZE_DUMMY 1024 /* 1024 bytes of dummy values */
  static const uint8_t dummyArr[SPI_WRITE_READ_BLOCK_SIZE_DUMMY] = {
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY,
    McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY, McuSDCard_DUMMY
  };
#else
  #error "only 512 and 1024 block size supported"
#endif
#endif
#define McuSDCard_SPI_WRITE(write)               ((void)McuGenericSWSPI_Write_ReadDummy(write))
#define McuSDCard_SPI_WRITE_READ(write, readP)   {(void)McuGenericSWSPI_SendChar(write); (void)McuGenericSWSPI_RecvChar(readP);}
#define McuSDCard_SPI_SetFastMode()              McuGenericSWSPI_SetFastMode()
#define McuSDCard_SPI_SetSlowMode()              McuGenericSWSPI_SetSlowMode()
#define McuSDCard_SPI_SetShiftClockPolarity(val) (void)McuGenericSWSPI_SetShiftClockPolarity(val)
#define McuSDCard_SPI_SetIdleClockPolarity(val)  (void)McuGenericSWSPI_SetIdleClockPolarity(val)

#if McuSDCard_SPI_WRITE_BLOCK_ENABLED
static void McuSDCard_SPI_WRITE_BLOCK(unsigned char *writeP, uint16_t size) {
  while(size>0) {
    McuGenericSWSPI_Write_ReadDummy(*writeP);
    writeP++;
    size--;
  }
}

static void McuSDCard_SPI_WRITE_READ_BLOCK(unsigned char *writeP, unsigned char *readP, uint16_t size) {
  uint8_t res;

  while(size>0) {
    res = McuGenericSWSPI_SendChar(*writeP);
    if (res!=ERR_OK) {
      break;
    }
    writeP++;
    res = McuGenericSWSPI_RecvChar(readP);
    if (res!=ERR_OK) {
      break;
    }
    readP++;
    size--;
  }
}
#endif /* McuSDCard_SPI_WRITE_BLOCK_ENABLED */

/* Internal method prototypes */
static uint8_t SendCommand(uint8_t cmd, uint8_t *arg, uint8_t response);

/*
** ===================================================================
**     Method      :  Activate (component SD_Card)
**
**     Description :
**         If multiple devices are used on the same SPI bus, then the
**         device needs to be activated. That way, the different SPI
**         protocol is selected.
**     Parameters  : None
**     Returns     : Nothing
** ===================================================================
*/
void McuSDCard_Activate(void)
{
  /* Note that the SD card SPI interface is defined with 'clock idle low polarity' and 'data shift on rising edge',
   * typically defined as well as 'Mode 0' (CPHA=0, CPOL=0). See http://elm-chan.org/docs/mmc/mmc_e.html
   */
  McuSDCard_InitCommChannel();
  McuSDCard_ENABLE_SS();                /* select slave */
}

/*
** ===================================================================
**     Method      :  Deactivate (component SD_Card)
**
**     Description :
**         Removes/deactivates the card from the bus
**     Parameters  : None
**     Returns     : Nothing
** ===================================================================
*/
void McuSDCard_Deactivate(void)
{
  McuSDCard_DISABLE_SS();               /* de-select slave */
}

/*
** ===================================================================
**     Method      :  WaitReady (component SD_Card)
**
**     Description :
**         Wait until the card is ready
**     Parameters  : None
**     Returns     :
**         ---             - Error code
**                           ERR_OK: device is ready
**                           ERR_BUSY: device is still busy
** ===================================================================
*/
uint8_t McuSDCard_WaitReady(void)
{
  uint8_t tmp;
  McuTimeout_CounterHandle timeout;

  McuSDCard_Activate();
  McuSDCard_SPI_WRITE(McuSDCard_DUMMY);
  timeout = McuTimeout_GetCounter(McuSDCard_TIMEOUT_READY_MS/McuTimeout_TICK_PERIOD_MS); /* set up timeout counter */
  for (;;) {                            /* will timeout */
    McuSDCard_SPI_WRITE_READ(McuSDCard_DUMMY, &tmp); /* write dummy value, read status */
    if (tmp==0xff) {
      break;
    }
    if (McuTimeout_CounterExpired(timeout)) {
      break;
    }
  } /* for */
  McuTimeout_LeaveCounter(timeout);
  McuSDCard_Deactivate();
  if (tmp==0xff) {
    return ERR_OK; /* device is ready */
  } else {
    return ERR_BUSY;
  }
}

/*
** ===================================================================
**     Method      :  ReceiveDataBlock (component SD_Card)
**
**     Description :
**         Retrieve a data block from the device
**     Parameters  :
**         NAME            - DESCRIPTION
**       * data            - Pointer to data buffer
**         nofBytes        - number of bytes to retrieve,
**                           must be a multiple of 4
**     Returns     :
**         ---             - TRUE if reading was going fine, FALSE
**                           otherwise.
** ===================================================================
*/
bool McuSDCard_ReceiveDataBlock(uint8_t *data, uint16_t nofBytes)
{
  uint8_t tmp;
  McuTimeout_CounterHandle timeout;
  word cnt = 512; /* polling counter */

  McuSDCard_Activate();
  /* poll response */
  do {
    McuSDCard_SPI_WRITE_READ(McuSDCard_DUMMY, &tmp); /* send dummy value, poll response */
    cnt--;
  } while (tmp==0xFF && cnt>0);
  if (tmp==0xFF) { /* polling not successful, now poll for a longer period of time */
    timeout = McuTimeout_GetCounter(McuSDCard_TIMEOUT_READ_BLOCK_MS/McuTimeout_TICK_PERIOD_MS); /* timeout */
    for (;;) {                          /* will timeout */
      McuSDCard_SPI_WRITE_READ(McuSDCard_DUMMY, &tmp); /* send dummy value, poll response */
      if (tmp!=0xFF) {
        break;
      }
      if (McuTimeout_Value(timeout)!=(McuSDCard_TIMEOUT_READ_BLOCK_MS/McuTimeout_TICK_PERIOD_MS)) {
        /* polled already for a tick period: use RTOS wait in order to balance CPU cycles */
        McuRTOS_vTaskDelay(portTICK_RATE_MS);
      }
      if (McuTimeout_CounterExpired(timeout)) {
        break;
      }
    } /* for */
    McuTimeout_LeaveCounter(timeout);
  } /* if */
  if (tmp != 0xFE) {                    /* if it is not expected response, return with error */
    McuSDCard_Deactivate();
    return FALSE;
  }
  /*lint -save -e539 Did not expect positive indentation  */
#if McuSDCard_SPI_WRITE_READ_BLOCK_ENABLED
  if (nofBytes<=SPI_WRITE_READ_BLOCK_SIZE_DUMMY) {
    McuSDCard_SPI_WRITE_READ_BLOCK((unsigned char*)&dummyArr[0], data, nofBytes); /* write dummy value, read data */
  } else {
#endif
    while(nofBytes>0) {
      McuSDCard_SPI_WRITE_READ(McuSDCard_DUMMY, data); /* write dummy value, read data */
      data++;
      nofBytes--;
    }
#if McuSDCard_SPI_WRITE_READ_BLOCK_ENABLED
  }
#endif
  /*lint -restore Did not expect positive indentation */
  McuSDCard_SPI_WRITE(McuSDCard_DUMMY); /* checksum Bytes not needed */
  McuSDCard_SPI_WRITE(McuSDCard_DUMMY);
  McuSDCard_Deactivate();
  return TRUE;
}

/*
** ===================================================================
**     Method      :  SendDataBlock (component SD_Card)
**
**     Description :
**         Send a data block to the device
**     Parameters  :
**         NAME            - DESCRIPTION
**       * data            - Pointer to data blocks with 512 bytes
**                           each
**         token           - data/stop token
**         nofBytes        - Number of bytes to send
**     Returns     :
**         ---             - Returns TRUE for success, FALSE for
**                           failure.
** ===================================================================
*/
bool McuSDCard_SendDataBlock(uint8_t *data, uint8_t token, uint16_t nofBytes)
{
  uint8_t resp;

  if (McuSDCard_WaitReady()!=ERR_OK) {
    return FALSE;                       /* device not ready */
  }
  McuSDCard_Activate();
  McuSDCard_SPI_WRITE(token);           /* Xmit data token */
  if (token != 0xFD) {                  /* Is data token, not STOP_TRAN */
#if McuSDCard_SPI_WRITE_BLOCK_ENABLED
    McuSDCard_SPI_WRITE_BLOCK(data, nofBytes);
#else
    while (nofBytes!=0) {               /* send the bytes */
      McuSDCard_SPI_WRITE(*data);
      data++;
      nofBytes--;
    }
#endif
    McuSDCard_SPI_WRITE(McuSDCard_DUMMY); /* CRC (Dummy) */
    McuSDCard_SPI_WRITE(McuSDCard_DUMMY); /* CRC (Dummy) */
    McuSDCard_SPI_WRITE_READ(McuSDCard_DUMMY, &resp); /* write dummy value, receive data response */
    if ((resp&0x1F) != 0x05) {          /* If not accepted, return with error */
      McuSDCard_Deactivate();
      return FALSE;
    }
    /* if we do not poll the device for its busy state, we need to provide at least 8 clocks (dummy cycle).
     * See http://elm-chan.org/docs/mmc/mmc_e.html:
     *    In principle of the SPI mode, the CS signal must be asserted during a transaction,
     *    however there is an exception to this rule. When the card is busy, the host controller
     *    can deassert CS to release SPI bus for any other SPI devices. The card will drive DO signal
     *    low again when reselect it during internal process is in progress.
     *    Therefore a preceding busy check (wait ready immediately before command and data packet)
     *    instead of post wait can eliminate waste wait time. In addition the internal process is initiated
     *    a byte after the data response, this means eight clocks are required to initiate internal write operation.
     */
    McuSDCard_SPI_WRITE(McuSDCard_DUMMY);
  }
  McuSDCard_Deactivate();
  return TRUE;
}

/*
** ===================================================================
**     Method      :  SendCmd (component SD_Card)
**
**     Description :
**         Sends a command to the device and returns the response
**     Parameters  :
**         NAME            - DESCRIPTION
**         cmd             - Command to send
**         arg             - command argument
**     Returns     :
**         ---             - device response
** ===================================================================
*/
uint8_t McuSDCard_SendCmd(uint8_t cmd, uint32_t arg)
{
  uint8_t n, res;
  McuTimeout_CounterHandle timeout;

  if (cmd&0x80) {                       /* ACMD<n> is the command sequence of CMD55-CMD<n> */
    cmd &= 0x7F;
    res = McuSDCard_SendCmd(McuSDCard_CMD55, 0);
    if (res > 1) {
      return res;
    }
  }
  /* Select the card and wait for ready */
  if (McuSDCard_WaitReady() != ERR_OK) {
    return 0xFF;
  }
  McuSDCard_Activate();
  /* Send command packet */
  McuSDCard_SPI_WRITE(cmd);             /* Start + Command index */
  n = (uint8_t)(arg>>24);
  McuSDCard_SPI_WRITE(n);               /* Argument[31..24] */
  n = (uint8_t)(arg>>16);
  McuSDCard_SPI_WRITE(n);               /* Argument[23..16] */
  n = (uint8_t)(arg>>8);
  McuSDCard_SPI_WRITE(n);               /* Argument[15..8] */
  McuSDCard_SPI_WRITE((uint8_t)arg);    /* Argument[7..0] */
  if (cmd == McuSDCard_CMD0) {
    n = 0x95;                           /* Valid CRC for CMD0(0) */
  } else if (cmd == McuSDCard_CMD8) {
    n = 0x87;                           /* Valid CRC for CMD8(0x1AA) */
  } else {
    n = 0x01;                           /* Dummy CRC + Stop */
  }
  McuSDCard_SPI_WRITE(n);
  /* Receive command response */
  if (cmd == McuSDCard_CMD12) {
    McuSDCard_SPI_WRITE_READ(McuSDCard_DUMMY, &res); /* send dummy value, poll response */
  }
  timeout = McuTimeout_GetCounter(McuSDCard_TIMEOUT_CMD_MS/McuTimeout_TICK_PERIOD_MS); /* timeout */
  for(;;) {                            /* will timeout */
    McuSDCard_SPI_WRITE_READ(McuSDCard_DUMMY, &res); /* send dummy value, poll response */
    if (!(res&0x80)) {                 /* valid response */
      break;
    }
    if (McuTimeout_CounterExpired(timeout)) {
      break;
    }
  }
  McuTimeout_LeaveCounter(timeout);
  McuSDCard_Deactivate();
  return res;                           /* Return with the response value */
}
/*
** ===================================================================
**     Method      :  isWriteProtected (component SD_Card)
**
**     Description :
**         Determines if the card is write protected. Note that this is
**         an indicator only, as it is still possible to write to the
**         card even if the write protection is set on the card!
**     Parameters  : None
**     Returns     :
**         ---             - True if the card has the write protection
**                           set, false otherwise
** ===================================================================
*/
/*
bool McuSDCard_isWriteProtected(void)
{
  *** method is implemented as macro in the header file
}
*/

/*
** ===================================================================
**     Method      :  SendCommand (component SD_Card)
**
**     Description :
**         This method is internal. It is used by Processor Expert only.
** ===================================================================
*/
static uint8_t SendCommand(uint8_t cmd, uint8_t *arg, uint8_t response)
{
  #define NOF_WAIT_ITERATIONS 3
  uint8_t u8Temp=0;
  uint8_t u8Counter;

  McuSDCard_Activate();
  McuSDCard_SPI_WRITE(cmd);             /* Send Start byte */
  /* Send Argument */
  for(u8Counter=0; u8Counter<4; u8Counter++) {
    McuSDCard_SPI_WRITE(arg[u8Counter]);
  }
  McuSDCard_SPI_WRITE(0x95);            /* Send CRC */
  /* Response Handler */
  for (u8Counter=0;u8Counter<NOF_WAIT_ITERATIONS;u8Counter++) {
    McuSDCard_SPI_WRITE_READ(McuSDCard_DUMMY, &u8Temp); /* send dummy value, poll response */
    if (u8Temp==response) {
      break;
    }
  } /* for */
  McuSDCard_Deactivate();
  if (u8Temp==response) {
    return ERR_OK;
  } else {
    return ERR_FAULT;
  }
}

/*
** ===================================================================
**     Method      :  Init (component SD_Card)
**
**     Description :
**         Initializes the driver
**     Parameters  :
**         NAME            - DESCRIPTION
**       * unused          - unused parameter
**     Returns     :
**         ---             - Error code
** ===================================================================
*/
uint8_t McuSDCard_Init(void* unused)
{
  /* The behavior of SD cards in SPI mode is basically the same as for any SPI slave device.
     The maximum transfer rate of the SD card in SPI mode is 25 Mbps, but in the initialization process the
     transfer rate must be less than 375 kbps. This is because the SPI mode of the SD cards is compatible with
     the MMC cards, and MMC cards can only reach 375 kbps. After initialization, the SPI clock can be
     changed to 25 Mbps.
     Note that the SPI interface is defined with 'clock idle low polarity' and 'data shift on rising edge',
     typically defined as well as 'Mode 0' (CPHA=0, CPOL=0). See http://elm-chan.org/docs/mmc/mmc_e.html
   */
  dword arg;
  McuTimeout_CounterHandle timeout;
  bool isTimeout = FALSE;
  uint8_t cnt;

  (void)unused;
  /* -------------------------------- Init & Slow Mode -------------------------------- */
  /* after voltage reaches 2.2V, need to wait at least 1 ms. Then we need to set Data and CS/Chipselect high for at least 74 clocks */
  /*lint -save -e522 function lacks side-effects */
  McuWait_Waitms(1);                    /* wait at least for 1 ms on insertion and power on */
  /*lint -restore */
  currentSpeedMode = McuSDCard_ACTIVATE_MODE_NONE;
  McuSDCard_Activate();                 /* select slave */
  McuSDCard_SetSlowMode();              /* set the SPI clock to 375 kbps. This is required for compatibility across a wide range of SD and MMC cards. */
  McuSDCard_DISABLE_SS();               /* disable slave (CS high) */
  for(cnt=0;cnt<10;cnt++) {             /* send at least 75 SPI clock cycles with the SS signal asserted to ensure that the SD card internal state machine is initialized. */
    McuSDCard_SPI_WRITE(McuSDCard_DUMMY);
  }
  /*lint -save -e522 function lacks side-effects */
  McuWait_Waitus(50);                   /* need to wait a little bin in order SPI transfer to be finished (need this on CN128, but on others too?) */
  /*lint -restore */
  McuSDCard_Deactivate();
  /* -------------------------------- IDLE Command -------------------------------- */
  arg = 0;
  timeout = McuTimeout_GetCounter(McuSDCard_TIMEOUT_READY_MS/McuTimeout_TICK_PERIOD_MS); /* timeout */
  while (SendCommand(McuSDCard_CMD0, (uint8_t*)&arg, McuSDCard_IDLE) != ERR_OK) {
    if (McuTimeout_CounterExpired(timeout)) {
      isTimeout = TRUE;                /* indicate a timeout */
      break;
    }
  } /* while */
  McuTimeout_LeaveCounter(timeout);
  if (isTimeout) {                      /* timeout */
    return ERR_FAULT;
  }
  /* Send 8 SPI clocks (SS unasserted). */
  McuSDCard_Activate();
  McuSDCard_DISABLE_SS();               /* disable slave */
  McuSDCard_SPI_WRITE(McuSDCard_DUMMY); /* dummy SPI cycle */
  McuSDCard_Deactivate();               /* de-select slave */
  return ERR_OK;
}

/*
** ===================================================================
**     Method      :  McuSDCard_ReceiveByte (component SD_Card)
**
**     Description :
**         This method is internal. It is used by Processor Expert only.
** ===================================================================
*/
uint8_t McuSDCard_ReceiveByte(void)
{
  uint8_t data;

  McuSDCard_Activate();
  McuSDCard_SPI_WRITE_READ(McuSDCard_DUMMY, &data); /* send dummy value, poll response */
  McuSDCard_Deactivate();
  return data;
}

/*
** ===================================================================
**     Method      :  CardPresent (component SD_Card)
**
**     Description :
**         Returns true in case a card is present. If there is no card
**         detection pin, then this routine will always return true.
**     Parameters  : None
**     Returns     :
**         ---             - Returns true if card is present, false
**                           otherwise.
** ===================================================================
*/
/*
bool McuSDCard_CardPresent(void)
{
  *** method is implemented as macro in the header file
}
*/

/*
** ===================================================================
**     Method      :  SetSlowMode (component SD_Card)
**
**     Description :
**         Switches to slow mode SPI communication speed.
**     Parameters  : None
**     Returns     : Nothing
** ===================================================================
*/
void McuSDCard_SetSlowMode(void)
{
  if (currentSpeedMode!=McuSDCard_ACTIVATE_MODE_SLOW) {
    /* not already in slow mode */
    McuSDCard_SPI_Disable();
    McuSDCard_SPI_SetSlowMode();        /* the SPI clock is set to the maximum supported by the MCU and allowed by the SD card */
    currentSpeedMode = McuSDCard_ACTIVATE_MODE_SLOW;
    McuSDCard_SPI_Enable();
  } /* if */
}

/*
** ===================================================================
**     Method      :  SetFastMode (component SD_Card)
**
**     Description :
**         Switches to fast mode SPI communication speed.
**     Parameters  : None
**     Returns     : Nothing
** ===================================================================
*/
void McuSDCard_SetFastMode(void)
{
  if (currentSpeedMode!=McuSDCard_ACTIVATE_MODE_FAST) {
    /* not already in fast mode */
    McuSDCard_SPI_Disable();
    McuSDCard_SPI_SetFastMode();        /* the SPI clock is set to the maximum supported by the MCU and allowed by the SD card */
    currentSpeedMode = McuSDCard_ACTIVATE_MODE_FAST;
    McuSDCard_SPI_Enable();
  } /* if */
}

/*
** ===================================================================
**     Method      :  InitCommChannel (component SD_Card)
**
**     Description :
**         Method to initialize the communication channel. This is
**         needed if the bus to the SD card is shared with other
**         devices.
**     Parameters  : None
**     Returns     : Nothing
** ===================================================================
*/
void McuSDCard_InitCommChannel(void)
{
  /* Settings:
    - 100-400 kHz clock during init, then max 12 MHz
    - Send MSB first
    - Shift clock idle polarity: low
    - Clock edge: falling edge
  */
  if (currentSpeedMode==McuSDCard_ACTIVATE_MODE_FAST) {
    McuSDCard_SetFastMode(); /* use fast mode. */
  } else if (currentSpeedMode==McuSDCard_ACTIVATE_MODE_SLOW) {
    McuSDCard_SetSlowMode(); /* use slow mode. */
  }
}

/*
** ===================================================================
**     Method      :  Deinit (component SD_Card)
**
**     Description :
**         Driver deinitialization routine.
**     Parameters  :
**         NAME            - DESCRIPTION
**       * unused          - dummy parameter
**     Returns     :
**         ---             - Error code
** ===================================================================
*/
uint8_t McuSDCard_Deinit(void* unused)
{
  (void)unused;
  return ERR_OK;
}

/* END McuSDCard. */

/*!
** @}
*/
